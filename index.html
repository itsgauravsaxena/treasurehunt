<!DOCTYPE html>
<html lang="da">
<head>
  <title>Skattejagt Kort</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    :root {
      --primary: #ff9800;
      --secondary: #333;
      --bg: #f9f9f9;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--secondary);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: var(--primary);
      color: #fff;
      padding: 12px;
      text-align: center;
      font-size: 1.4em;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    #map {
      flex: 1;
      width: 100%;
    }
    .leaflet-popup-content {
      font-size: 1rem;
      font-weight: 500;
    }
    @media (max-width: 600px) {
      header {
        font-size: 1.1em;
        padding: 10px;
      }
      .leaflet-popup-content {
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div id="team-header" style="display:none;">
      <span id="team-name-display" style="font-weight:bold;"></span>
      <span id="team-score" style="margin-left:16px;font-weight:bold;">Point: 0</span>
      <button id="reset-btn" style="margin-left:16px;padding:4px 12px;border-radius:6px;border:none;background:#fff;color:var(--primary);font-size:0.8em;cursor:pointer;">Start Forfra</button>
    </div>
    <div id="team-setup" style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px;">
      <label for="team-name" style="font-size:1.1em;margin-bottom:6px;">Hvad hedder jeres seje hold?</label>
      <input id="team-name" type="text" style="padding:6px 12px;border-radius:6px;border:1px solid #ccc;font-size:1em;" placeholder="Holdnavn" />
      <button id="start-btn" style="margin-top:10px;padding:6px 18px;border-radius:6px;border:none;background:var(--primary);color:#fff;font-size:1em;cursor:pointer;">Start Skattejagten!</button>
    </div>
  </header>
  <div id="map" style="display:none;"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Team setup and score logic
    var teamName = localStorage.getItem('teamName') || '';
    var solvedClues = JSON.parse(localStorage.getItem('solvedClues') || '[]');

    function updateScore() {
      document.getElementById('team-score').textContent = 'Point: ' + solvedClues.length;
    }

    function showMap() {
      document.getElementById('team-setup').style.display = 'none';
      document.getElementById('map').style.display = 'block';
      document.getElementById('team-header').style.display = 'block';
      document.getElementById('team-name-display').textContent = teamName ? 'Hold: ' + teamName : '';
      updateScore();
      // Invalidate map size to ensure it renders correctly after being un-hidden
      setTimeout(function() {
        map.invalidateSize();
      }, 0);
    }

    document.getElementById('start-btn').onclick = function() {
      var input = document.getElementById('team-name');
      var name = input.value.trim();
      if (!name) {
        input.style.borderColor = 'red';
        input.focus();
        return;
      }
      teamName = name;
      localStorage.setItem('teamName', teamName);
      showMap();
    };

    // Allow pressing Enter to start
    document.getElementById('team-name').addEventListener('keyup', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        document.getElementById('start-btn').click();
      }
    });
    // If team name already set, skip setup
    if (teamName) {
      showMap();
      document.getElementById('team-name').value = teamName;
    }

    // Reset game logic
    document.getElementById('reset-btn').onclick = function() {
      if (confirm('Er I sikre p√•, I vil starte forfra? Alle jeres point og jeres holdnavn forsvinder.')) {
        // Clear all saved data from localStorage
        localStorage.removeItem('teamName');
        localStorage.removeItem('solvedClues');

        // Reset in-memory variables
        teamName = '';
        solvedClues = [];

        // Reload the page to go back to the setup screen
        window.location.reload();
      }
    };

    // Initialize map with smooth zoom and optimized rendering
    var map = L.map('map', {
      zoomControl: false,
      preferCanvas: true
    }).setView([55.687866247454544, 12.440356125771856], 14);

    L.control.zoom({ position: 'topright' }).addTo(map);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Define treasure hunt markers with options
    var clues = [
      {
        coords: [55.68708054917811, 12.441355926742244],
        text: "ü™ô F√∏rste spor: Kig ved det store springvand!",
        options: ["B√¶nk", "Springvand", "Statue"],
        answer: "Springvand",
        type: "options"
      },
      {
        coords: [55.68696448408725, 12.437444152834074],
        text: "üå≥ Andet spor: Skatten gemmer sig under det h√∏je egetr√¶!",
        options: ["Fyrretr√¶", "Egetr√¶", "Birketr√¶"],
        answer: "Egetr√¶",
        type: "options"
      },
      {
        coords: [55.68701542511072, 12.435067896667386],
        text: "üé† Tredje spor: Find det sted, hvor b√∏rn elsker at lege.",
        answer: "Legeplads",
        type: "text"
      },
      {
        coords: [55.6888914067698, 12.43559286853583],
        text: "‚òÄÔ∏è Fjerde spor: Skatten er begravet, hvor solen skinner klart.",
        options: ["Skygge", "Solrig mark", "Flodbred"],
        answer: "Solrig mark",
        type: "options"
      },
      {
        coords: [55.690002484238356, 12.436452599450709],
        text: "ü§´ Femte spor: Et hemmeligt sted, hvor solen altid kan finde dig.",
        answer: "Solrig mark",
        type: "text"
      }
    ];

    // Define default and checkmark icons
    var defaultIcon = L.icon({
      iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      shadowSize: [41, 41]
    });

    var checkIcon = L.icon({
      iconUrl: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2705.png', // checkmark emoji
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -28]
    });

    // Add markers with interactive popups
    var markers = [];
    clues.forEach(function(clue, idx) {
      var icon = solvedClues.includes(idx) ? checkIcon : defaultIcon;
      var marker = L.marker(clue.coords, { icon: icon }).addTo(map);
      markers.push(marker);

      // Build the popup content once
      var popupContent = `<b>${clue.text}</b><br><div id='options-${idx}'>`;
      if (clue.type === "options") {
        clue.options.forEach(function(opt) {
          popupContent += `<button style='margin:4px 2px;padding:4px 10px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer;' onclick=\"window.selectAnswer(${idx}, '${opt}')\">${opt}</button>`;
        });
      } else if (clue.type === "text") {
        popupContent += `<input type='text' id='input-${idx}' style='margin:4px 2px;padding:4px 10px;border-radius:6px;border:1px solid #ccc;width:120px;' placeholder='Skriv jeres svar...' />`;
        popupContent += `<button style='margin:4px 2px;padding:4px 10px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer;' onclick=\"window.submitTextAnswer(${idx})\">G√¶t</button>`;
      }
      popupContent += `</div><div id='feedback-${idx}' style='margin-top:8px;'></div>`;
      marker.bindPopup(popupContent);
    });

    // Add answer selection handler to window
    window.selectAnswer = function(idx, selected) {
      var clue = clues[idx];
      var feedbackDiv = document.getElementById('feedback-' + idx);
      if (selected === clue.answer) {
        feedbackDiv.innerHTML = `<span style='color:green;font-weight:bold;'>Helt rigtigt! Godt g√•et! üéâ</span>`;
        // Change marker icon to checkmark
        markers[idx].setIcon(checkIcon);
        // Save solved clue in localStorage
        if (!solvedClues.includes(idx)) {
          solvedClues.push(idx);
          localStorage.setItem('solvedClues', JSON.stringify(solvedClues));
          updateScore();
        }
      } else {
        feedbackDiv.innerHTML = `<span style='color:red;font-weight:bold;'>Pr√∏v igen! I kan godt! üí™</span>`;
      }
    };

    window.submitTextAnswer = function(idx) {
      var clue = clues[idx];
      var input = document.getElementById('input-' + idx);
      var feedbackDiv = document.getElementById('feedback-' + idx);
      if (!input) return;
      var val = input.value.trim();
      if (val.toLowerCase() === clue.answer.toLowerCase()) {
        feedbackDiv.innerHTML = `<span style='color:green;font-weight:bold;'>Helt rigtigt! Godt g√•et! üéâ</span>`;
        markers[idx].setIcon(checkIcon);
        if (!solvedClues.includes(idx)) {
          solvedClues.push(idx);
          localStorage.setItem('solvedClues', JSON.stringify(solvedClues));
          updateScore();
        }
      } else {
        feedbackDiv.innerHTML = `<span style='color:red;font-weight:bold;'>Pr√∏v igen! I kan godt! üí™</span>`;
      }
    };
  </script>
</body>
</html>